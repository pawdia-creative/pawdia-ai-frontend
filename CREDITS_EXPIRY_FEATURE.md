# 积分有效期功能

## 功能概述

**积分有效期规则：**
- **Free用户**：3个积分永久有效（无过期时间）
- **付费订阅**（Basic/Premium）：获得的积分具有一个月（30天）的有效期
- **积分包购买**：通过购买积分包获得的积分具有一个月（30天）的有效期

过期后积分将自动清零。

## 实现细节

### 数据库变更

- 在 `users` 表中添加了 `credits_expires` 字段（DATETIME 类型）
- 添加了相应的索引以优化查询性能

### 订阅逻辑

当用户购买订阅时：
- **Free订阅**：获得3个积分，`credits_expires` 字段保持 `NULL`（永久有效）
- **付费订阅**（Basic/Premium）：获得相应积分，`credits_expires` 字段设置为当前时间 + 30天
- **积分包购买**：获得相应积分，`credits_expires` 字段设置为当前时间 + 30天

### 过期清理

- `cleanExpiredCredits()` 函数会检查所有用户的积分过期时间
- 过期的积分会被重置为 0，`credits_expires` 字段会被清空
- 该函数在以下时机被调用：
  - 用户访问 `/api/auth/me` 时（最常用）
  - 用户积分被更新时（`updateUserCredits`）

### 迁移

- 现有数据库已添加 `credits_expires` 字段
- 所有活跃订阅用户（`subscription_status = 'active'` 且 `credits > 0`）的积分已设置为30天后过期

## 测试

可以使用 `scripts/test-credits-expiry.js` 中的命令来测试功能：

1. 检查用户积分和过期时间
2. 手动设置过期时间进行测试
3. 验证自动清理功能

## 注意事项

- 积分过期是自动的，不需要手动干预
- **Free用户**的3个积分永久有效
- **付费订阅**（Basic/Premium）和**积分包购买**获得的积分具有30天有效期
- 管理员手动添加积分默认不会设置过期时间（除非明确指定）
- 过期清理是惰性执行的（在用户访问相关接口时）
